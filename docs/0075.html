<html>
<head>
<title>Running a High Traffic Rails App on Heroku’s Performance Dynos</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">在Heroku的Performance Dynos上运行高流量Rails应用程序</h1>
<blockquote>原文：<a href="https://medium.com/swlh/running-a-high-traffic-rails-app-on-heroku-s-performance-dynos-d9e6833d34c4?source=collection_archive---------1-----------------------#2015-08-24">https://medium.com/swlh/running-a-high-traffic-rails-app-on-heroku-s-performance-dynos-d9e6833d34c4?source=collection_archive---------1-----------------------#2015-08-24</a></blockquote><div><div class="ds gw gx gy gz ha"/><div class="hb hc hd he hf"><div class=""/><p id="0c4a" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated"><em class="jd">TLDR；如果你目前使用的是10+2x dyno。考虑使用性能dynos。如果20–30个2X dynos，</em> <strong class="ih je"> <em class="jd">肯定</em> </strong> <em class="jd">使用性能dynos。</em></p><p id="760c" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">Heroku最近宣布了他们的新性能-M(250美元/月)和性能-L(500美元/月)dynos。这是我们在<a class="ae jf" href="https://www.producthunt.com" rel="noopener ugc nofollow" target="_blank">寻找产品</a>的绝佳时机。刚刚推出<a class="ae jf" rel="noopener" href="/@rrhoover/product-hunt-live-c52ef07417f1"> LIVE </a>，我们的流量就失控了。</p><h2 id="015f" class="jg jh hi bd ji jj jk jl jm jn jo jp jq iq jr js jt iu ju jv jw iy jx jy jz ka bi translated"><strong class="ak">这里是新的动态统计数据</strong></h2><figure class="kc kd ke kf fd kg er es paragraph-image"><div role="button" tabindex="0" class="kh ki di kj bf kk"><div class="er es kb"><img src="../Images/e4f581677a8067c7485802963027a02e.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*J5gLmOQSaNCtK6vAEr9InQ.png"/></div></div><figcaption class="kn ko et er es kp kq bd b be z dx">source: <a class="ae jf" href="https://devcenter.heroku.com/articles/dyno-types" rel="noopener ugc nofollow" target="_blank">https://devcenter.heroku.com/articles/dyno-types</a></figcaption></figure><p id="2d0d" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">我很高兴看到14gb内存的Performance-L，它似乎非常适合我们参加<a class="ae jf" href="https://www.producthunt.com" rel="noopener ugc nofollow" target="_blank">产品搜索</a>。</p><p id="96dc" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">当查看PL dyno时，我查看的第一个因素是每个Ruby进程的成本。对于产品搜索，我们目前的成本是2X上每个进程大约25美元，根据一些简单的数学计算，PL上大约是17.86美元。</p><figure class="kc kd ke kf fd kg er es paragraph-image"><div class="er es kr"><img src="../Images/6967631d33bb711076ae0bedc862c578.png" data-original-src="https://miro.medium.com/v2/resize:fit:1090/format:webp/1*nKJHuuhK0aAEWSpf1vgvUw.png"/></div><figcaption class="kn ko et er es kp kq bd b be z dx">Highly “scientific” math 😎. Calc cost per process.</figcaption></figure><h2 id="dbd6" class="jg jh hi bd ji jj jk jl jm jn jo jp jq iq jr js jt iu ju jv jw iy jx jy jz ka bi translated">为什么要看每个进程的费用？</h2><p id="55c1" class="pw-post-body-paragraph if ig hi ih b ii ks ik il im kt io ip iq ku is it iu kv iw ix iy kw ja jb jc hb bi translated">在扩展Rails应用时，我们关注的一个关键指标是它可以处理的并发请求数量。Ruby on Rails应用程序通常使用大量内存，并且不受CPU限制。当使用Ruby MRI(单线程)时，这意味着单个服务器(dyno)只能同时响应机器上运行的Ruby进程的数量。</p><p id="94aa" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">如果我们使用的是Puma，每个Puma进程使用300MB内存，那么2X dyno只能运行3个进程(并发处理3个请求)。</p><h1 id="d60f" class="kx jh hi bd ji ky kz la jm lb lc ld jq le lf lg jt lh li lj jw lk ll lm jz ln bi translated">结果:产品搜索性能-L Dyno</h1><p id="99c1" class="pw-post-body-paragraph if ig hi ih b ii ks ik il im kt io ip iq ku is it iu kv iw ix iy kw ja jb jc hb bi translated">我已经知道，从成本角度来看，转向PL是有意义的。我知道会有一些性能提升(专用CPU，更少的可变性能)。但是我没有预料到我们经历的疯狂的性能提升。</p><p id="59f9" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">我们改用Performance-L dyno后，性能比2倍的dyno提高了3倍。😎</p><p id="e515" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">检查这个<a class="ae jf" href="http://newrelic.com" rel="noopener ugc nofollow" target="_blank">新遗迹</a>过渡期间的响应时间图。</p><figure class="kc kd ke kf fd kg er es paragraph-image"><div class="er es lo"><img src="../Images/95d383559316d312f5aa2f0bdc96795f.png" data-original-src="https://miro.medium.com/v2/resize:fit:1296/format:webp/1*ObTPN_uDNharqdouuT9oEQ.png"/></div></figure><p id="bb0c" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">在左侧，我们运行了<strong class="ih je"> 30个2X测功器</strong>。在右边，我们正在运行<strong class="ih je"> 3 PL dynos </strong>。成本相同，性能提高3倍，请求响应时间的可变性更小。</p><p id="8a63" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated"><strong class="ih je"> <em class="jd">注</em> </strong>:你的经历<strong class="ih je">会</strong>有所不同。我们性能的大幅提升主要归功于更强大的CPU。在我们的应用程序中，我们使用rubyracer 进行预渲染反应(这在很大程度上受到CPU的限制)。</p><p id="7067" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">我们在<a class="ae jf" href="https://codeship.com" rel="noopener ugc nofollow" target="_blank"> Codeship </a>的朋友也做了改变，并注意到类似的结果。</p><figure class="kc kd ke kf fd kg"><div class="bz dy l di"><div class="lp lq l"/></div></figure><h1 id="6314" class="kx jh hi bd ji ky kz la jm lb lc ld jq le lf lg jt lh li lj jw lk ll lm jz ln bi translated">如何过渡到高性能-L Dyno</h1><p id="457c" class="pw-post-body-paragraph if ig hi ih b ii ks ik il im kt io ip iq ku is it iu kv iw ix iy kw ja jb jc hb bi translated">1.首先，你需要确定你当前的dynos在<strong class="ih je">生产</strong>中使用了多少内存。</p><p id="4297" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">您可以通过多种方式实现这一点:</p><ul class=""><li id="80e3" class="lr ls hi ih b ii ij im in iq lt iu lu iy lv jc lw lx ly lz bi translated">启用<em class="jd">日志运行时指标</em>并查看您的日志</li><li id="f72a" class="lr ls hi ih b ii ma im mb iq mc iu md iy me jc lw lx ly lz bi translated">使用<a class="ae jf" href="http://dashboard.heroku.com" rel="noopener ugc nofollow" target="_blank"> Heroku仪表盘</a></li><li id="bb4d" class="lr ls hi ih b ii ma im mb iq mc iu md iy me jc lw lx ly lz bi translated">设置一个类似<a class="ae jf" href="https://addons.heroku.com/librato" rel="noopener ugc nofollow" target="_blank"> Librato </a>的工具</li></ul><p id="33c3" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">用总内存使用量除以在dyno上运行的进程数，可以确定每个进程的内存使用量。</p><p id="8fc0" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">2.接下来，在您的<strong class="ih je"> staging </strong>环境中，您需要将web dynos的大小调整为Performance-L。</p><pre class="kc kd ke kf fd mf mg mh mi aw mj bi"><span id="7d6b" class="jg jh hi mg b fi mk ml l mm mn"> $ heroku ps:resize web=Performance-L --app your-staging-app</span></pre><p id="b666" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">3.您需要确定在Performance-L dyno上运行的进程数量。为此，您将使用14GB(PL上的内存)除以每个进程的内存使用量。如果我们的应用程序每个进程占用500MB，我们可以在PL dyno上运行28个进程。</p><p id="885f" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated"><strong class="ih je"> <em class="jd">注意:</em> </strong>我最初喜欢保守一点，使用比我认为dyno上能容纳的进程数量更少的进程。安全总比以后投入生产好。</p><p id="3e3a" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">4.现在，您需要在您的登台环境中调整每个dyno上运行的Ruby进程的数量。下一步将根据您设置的服务器和环境变量而有所不同。该命令可能如下所示。您需要为您的应用程序引用puma或unicorn配置文件，以准确地知道要更改哪个ENV变量。</p><pre class="kc kd ke kf fd mf mg mh mi aw mj bi"><span id="9a7f" class="jg jh hi mg b fi mk ml l mm mn">$ heroku config:set WEB_CONCURRENCY=20 --app your-staging-app</span></pre><p id="cd6f" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">5.此时做一个负载测试&amp;监控内存使用/ CPU负载是一个好主意。我推荐使用<a class="ae jf" href="https://www.joedog.org/siege-home/" rel="noopener ugc nofollow" target="_blank">围攻</a>进行简单的负载测试，并使用<a class="ae jf" href="https://addons.heroku.com/librato" rel="noopener ugc nofollow" target="_blank"> Librato </a>进行监控(升级到更高的计划以获得更详细的5分钟指标)。</p><p id="436a" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated"><strong class="ih je"> <em class="jd">注</em> </strong>:关于如何进行负载测试的细节，在我的书《Heroku apps负载测试中有一章是关于<a class="ae jf" href="http://www.amazon.com/Heroku-Cookbook-Mike-Coutermarsh/dp/1782177949" rel="noopener ugc nofollow" target="_blank">的。</a></p><p id="a006" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">6.一旦您对您的分段应用程序进行了负载测试，并对性能感到满意(没有R14崩溃)。生产中是时候这么做了。你可以在不停机的情况下做到这一点，但需要小心。</p><p id="fb45" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated"><strong class="ih je"> <em class="jd">注意:</em> </strong>记住你可用的数据库连接(或者redis/memcached/etc)。如果每个进程使用1个连接，做一些快速的计算，确保你不会在升级过程中耗尽连接。您可以运行<strong class="ih je"><em class="jd">$ heroku pg:info</em></strong>来检查您当前的数据库连接和限制。</p><p id="29ff" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">7.要在<strong class="ih je">生产</strong>中进行转换，首先缩小您正在运行的dyno的数量&amp;，然后调整到PL(每个应用程序有10个PL dynos的限制，如果您给Heroku发电子邮件，可以取消此限制)。</p><pre class="kc kd ke kf fd mf mg mh mi aw mj bi"><span id="91cd" class="jg jh hi mg b fi mk ml l mm mn">$ heroku ps:scale web=3 --app your-production-app<br/>$ heroku ps:resize web=Performance-L --app your-production-app<br/>$ heroku config:set WEB_CONCURRENCY=20 --app your-production-app</span></pre><p id="721d" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">8.你完了！现在监控Librato/New Relic。几个小时后，您将对您的应用程序在PL dyno上使用了多少内存有一个很好的了解，并可以相应地调整并发性。</p><figure class="kc kd ke kf fd kg"><div class="bz dy l di"><div class="lp lq l"/></div></figure><p id="d11d" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">升级到Performance-L dynos为我们在<a class="ae jf" href="https://www.producthunt.com" rel="noopener ugc nofollow" target="_blank">产品搜寻</a>中带来了巨大的性能提升。它以更快的页面加载速度改善了用户体验，并降低了我们的Heroku账单。如果您在Heroku上运行的应用程序的速度范围是10–30 2X dynos，那么您应该考虑使用Performance-L。</p><figure class="kc kd ke kf fd kg er es paragraph-image"><div class="er es mo"><img src="../Images/d36753172e4c14d170b1f8bde7b00002.png" data-original-src="https://miro.medium.com/v2/resize:fit:1000/1*Pd3j3qr3YQzeij9hGXaD9A.gif"/></div></figure><figure class="kc kd ke kf fd kg er es paragraph-image"><div role="button" tabindex="0" class="kh ki di kj bf kk"><div class="er es mp"><img src="../Images/71d955550911c61d0aef4c66a71f8e15.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*VLaJ04qsuIGx2MkIAZKDdQ.jpeg"/></div></div></figure></div><div class="ab cl mq mr gp ms" role="separator"><span class="mt bw bk mu mv mw"/><span class="mt bw bk mu mv mw"/><span class="mt bw bk mu mv"/></div><div class="hb hc hd he hf"><p id="5b50" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">🌟你可以在这里加入我的电子邮件列表。每次我发布新的东西，我都会发送一个更新。</p></div></div>    
</body>
</html>