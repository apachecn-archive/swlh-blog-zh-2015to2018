<html>
<head>
<title>A Sufficiently Complex Cloud Application</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">足够复杂的云应用程序</h1>
<blockquote>原文：<a href="https://medium.com/swlh/a-sufficiently-complex-cloud-application-842a13529648?source=collection_archive---------14-----------------------#2018-12-31">https://medium.com/swlh/a-sufficiently-complex-cloud-application-842a13529648?source=collection_archive---------14-----------------------#2018-12-31</a></blockquote><div><div class="ds gw gx gy gz ha"/><div class="hb hc hd he hf"><div class=""/><div class=""><h2 id="9276" class="pw-subtitle-paragraph if hh hi bd b ig ih ii ij ik il im in io ip iq ir is it iu iv iw dx translated">构建由AWS支持的视频稳定服务</h2></div><h1 id="1238" class="ix iy hi bd iz ja jb jc jd je jf jg jh io ji ip jj ir jk is jl iu jm iv jn jo bi translated">足够的复杂性</h1><p id="6e8d" class="pw-post-body-paragraph jp jq hi jr b js jt ij ju jv jw im jx jy jz ka kb kc kd ke kf kg kh ki kj kk hb bi translated">学习的最好方法之一是建立一个足够复杂的例子，然后教给其他人。在这篇文章中，我们将涵盖几乎所有需要建立一个视频稳定服务。它将允许用户上传视频文件，ffmpeg将负责执行视频稳定。</p><pre class="kl km kn ko fd kp kq kr ks aw kt bi"><span id="499a" class="ku iy hi kq b fi kv kw l kx ky"># Calculate transform vectors<br/>ffmpeg -i shaky-video.mp4 -vf vidstabdetect=stepsize=6:shakiness=5:accuracy=15:result=transform_vectors.trf -f null -</span><span id="09be" class="ku iy hi kq b fi kz kw l kx ky"># Stabilize the video<br/>ffmpeg -i shaky-video.mp4 -vf vidstabtransform=input=transform_vectors.trf:zoom=0:smoothing=30:crop=black,unsharp=5:5:0.8:3:3:0.4 -vcodec libx264 -preset slow -tune film -crf 18 -acodec copy stabilized-video.mp4</span></pre><p id="4c5c" class="pw-post-body-paragraph jp jq hi jr b js la ij ju jv lb im jx jy lc ka kb kc ld ke kf kg le ki kj kk hb bi translated">这可能看起来太琐碎了，即使是Hello World的变化，但一旦我们将各种AWS服务连接在一起，并应用一些<a class="ae lf" href="https://d1.awsstatic.com/whitepapers/architecture/AWS_Well-Architected_Framework.pdf" rel="noopener ugc nofollow" target="_blank">云最佳实践</a>，它将很快变得足够复杂，以学习有价值的课程。</p><h1 id="5218" class="ix iy hi bd iz ja jb jc jd je jf jg jh io ji ip jj ir jk is jl iu jm iv jn jo bi translated">在EC2中手动运行脚本</h1><p id="61cb" class="pw-post-body-paragraph jp jq hi jr b js jt ij ju jv jw im jx jy jz ka kb kc kd ke kf kg kh ki kj kk hb bi translated">让我们从简单开始，让上面的脚本在云中运行。由于这是一个长时间运行的流程，可能比Lambda的15分钟最大超时时间还要长，所以这个流程将在EC2实例上运行。</p><figure class="kl km kn ko fd lh er es paragraph-image"><div role="button" tabindex="0" class="li lj di lk bf ll"><div class="er es lg"><img src="../Images/97a343fdc2771c712ef72c83328bb6a7.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*tzm_gc7hFWhMk4VYt32p_w.png"/></div></div></figure><figure class="kl km kn ko fd lh er es paragraph-image"><div role="button" tabindex="0" class="li lj di lk bf ll"><div class="er es lo"><img src="../Images/f576ab683aeb3d9ca956b0fce05fecb5.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*xso0JI6kU6AQRF41tcnn_A.png"/></div></div></figure><p id="de12" class="pw-post-body-paragraph jp jq hi jr b js la ij ju jv lb im jx jy lc ka kb kc ld ke kf kg le ki kj kk hb bi translated">为了简单起见，我选择了一个运行在自由层硬件上的Amazon Linux 2实例。在将实例启动到可公开访问的子网I中之后，使用curl下载ffmpeg，并将两个ffmpeg命令粘贴到bash脚本中。</p><figure class="kl km kn ko fd lh er es paragraph-image"><div role="button" tabindex="0" class="li lj di lk bf ll"><div class="er es lp"><img src="../Images/959c12f151cd9f84ff3480d7c9f54782.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*ZLjYMqy5N7YkmphOZkQLxQ.png"/></div></div></figure><p id="eecf" class="pw-post-body-paragraph jp jq hi jr b js la ij ju jv lb im jx jy lc ka kb kc ld ke kf kg le ki kj kk hb bi translated">命令已经到位，但我们需要一个不稳定的视频来稳定。我们还需要一种方法使EC2实例可以访问该视频。在可用的<a class="ae lf" href="https://aws.amazon.com/products/storage/" rel="noopener ugc nofollow" target="_blank">存储选项</a>中，S3最有意义，因为我们希望用户能够通过HTTPS上传视频。</p><p id="d098" class="pw-post-body-paragraph jp jq hi jr b js la ij ju jv lb im jx jy lc ka kb kc ld ke kf kg le ki kj kk hb bi translated">创建bucket时的一个重要部分是确保它不会被公开访问。没有必要允许对S3桶的开放访问，出于安全和隐私的原因，我们无论如何也不希望那扇门打开。</p><figure class="kl km kn ko fd lh er es paragraph-image"><div role="button" tabindex="0" class="li lj di lk bf ll"><div class="er es lq"><img src="../Images/57ebee4d0a09a2736a54e40286c79841.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*zns3cReeEAcdbrulAHP1Aw.png"/></div></div></figure><figure class="kl km kn ko fd lh er es paragraph-image"><div role="button" tabindex="0" class="li lj di lk bf ll"><div class="er es lr"><img src="../Images/39cc59fa31e4b67e72e02ff2de8453aa.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*01NcxtNSQvYHmJCledDQ2A.png"/></div></div></figure><p id="a2d0" class="pw-post-body-paragraph jp jq hi jr b js la ij ju jv lb im jx jy lc ka kb kc ld ke kf kg le ki kj kk hb bi translated">随着S3桶创建，让我们上传一个视频到S3稳定。</p><figure class="kl km kn ko fd lh er es paragraph-image"><div class="er es ls"><img src="../Images/4641e9c8eb328aedd1f7575441f4bc24.png" data-original-src="https://miro.medium.com/v2/resize:fit:1200/1*n7HlKjqq8b-hdfRBUh_9_Q.gif"/></div><figcaption class="lt lu et er es lv lw bd b be z dx">What is this? See <a class="ae lf" href="https://insights.aviture.us.com/blog/how-we-used-observables-for-3d-reconstruction" rel="noopener ugc nofollow" target="_blank">https://insights.aviture.us.com/blog/how-we-used-observables-for-3d-reconstruction</a></figcaption></figure><p id="45b9" class="pw-post-body-paragraph jp jq hi jr b js la ij ju jv lb im jx jy lc ka kb kc ld ke kf kg le ki kj kk hb bi translated">现在将视频从S3传送到EC2实例。我们应该能够用AWS CLI来完成这个任务。</p><figure class="kl km kn ko fd lh er es paragraph-image"><div role="button" tabindex="0" class="li lj di lk bf ll"><div class="er es lx"><img src="../Images/205daa9eea049be4591001835b12c880.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*ITfVk30VgWXIJKt0d7aY-g.png"/></div></div></figure><p id="2119" class="pw-post-body-paragraph jp jq hi jr b js la ij ju jv lb im jx jy lc ka kb kc ld ke kf kg le ki kj kk hb bi translated">对，这个EC2实例没有与S3对话的权限。解决这个问题的正确方法是创建一个新策略，将该策略分配给一个角色，并将该角色分配给EC2实例。</p><figure class="kl km kn ko fd lh er es paragraph-image"><div role="button" tabindex="0" class="li lj di lk bf ll"><div class="er es ly"><img src="../Images/9f090b2bef7a40a9543018f3c1b663fe.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*iIrXJ4UJfzk5sh8UIG-JBg.png"/></div></div></figure><figure class="kl km kn ko fd lh er es paragraph-image"><div role="button" tabindex="0" class="li lj di lk bf ll"><div class="er es lz"><img src="../Images/2d35091f6ef3f39b4aedc3b38677e2d6.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*oa2wYjZnCx8nhCdhdxl8Gw.png"/></div></div></figure><p id="2509" class="pw-post-body-paragraph jp jq hi jr b js la ij ju jv lb im jx jy lc ka kb kc ld ke kf kg le ki kj kk hb bi translated">完全的S3访问权限在这里有些过头了，但是一旦这个概念被证明是正确的，我们可以回过头来使权限更加严格。</p><figure class="kl km kn ko fd lh er es paragraph-image"><div role="button" tabindex="0" class="li lj di lk bf ll"><div class="er es ma"><img src="../Images/a7e4618c3821eccc1a528142cf93b773.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*xDkLxgLrBetEoE2q9PZb7g.png"/></div></div></figure><p id="58c3" class="pw-post-body-paragraph jp jq hi jr b js la ij ju jv lb im jx jy lc ka kb kc ld ke kf kg le ki kj kk hb bi translated">最后，我们可以运行脚本，并将结果上传回S3下载。</p><figure class="kl km kn ko fd lh er es paragraph-image"><div role="button" tabindex="0" class="li lj di lk bf ll"><div class="er es mb"><img src="../Images/907e8eb1f62fff9aef71362bff0ea2e6.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*uRJOU4JW-r3h96kYvPAw1g.png"/></div></div></figure><figure class="kl km kn ko fd lh er es paragraph-image"><div class="er es ls"><img src="../Images/5959db6377c43ac5921554e769c253f4.png" data-original-src="https://miro.medium.com/v2/resize:fit:1200/1*kG2gOssRAa0g1GzDsn_IcA.gif"/></div></figure><p id="36b6" class="pw-post-body-paragraph jp jq hi jr b js la ij ju jv lb im jx jy lc ka kb kc ld ke kf kg le ki kj kk hb bi translated">现在我们有了。我们证明了Hello World质量应用程序，现在我们应该开始努力让用户上传功能，但我们应该首先解决一些最佳实践。</p><h1 id="c0d6" class="ix iy hi bd iz ja jb jc jd je jf jg jh io ji ip jj ir jk is jl iu jm iv jn jo bi translated">将EC2与S3脱钩</h1><p id="6ce4" class="pw-post-body-paragraph jp jq hi jr b js jt ij ju jv jw im jx jy jz ka kb kc kd ke kf kg kh ki kj kk hb bi translated">我们的EC2实例需要知道何时从S3下载新视频。我们可以让EC2直接轮询S3，但是反复轮询S3的新视频既不高效也不符合架构。然而，有一种AWS服务是专门用来分离架构组件的，这种服务就是<strong class="jr mc"> SQS </strong>。</p><figure class="kl km kn ko fd lh er es paragraph-image"><div role="button" tabindex="0" class="li lj di lk bf ll"><div class="er es md"><img src="../Images/3e74f28730742bf691677abf4cade0fc.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*WZTxnfhN1F8h-oHGSedx4w.png"/></div></div></figure><p id="2dd0" class="pw-post-body-paragraph jp jq hi jr b js la ij ju jv lb im jx jy lc ka kb kc ld ke kf kg le ki kj kk hb bi translated">从概念上讲，我们想要完成的是，当一个新的视频被上传到S3桶时，一条消息被发布到SQS。在EC2实例上无限循环运行的脚本将对队列执行<a class="ae lf" href="https://docs.aws.amazon.com/AWSSimpleQueueService/latest/SQSDeveloperGuide/sqs-long-polling.html" rel="noopener ugc nofollow" target="_blank">长轮询</a>，当检测到消息时，它将从消息中读取桶/密钥，并从S3下载视频。</p><p id="a5b3" class="pw-post-body-paragraph jp jq hi jr b js la ij ju jv lb im jx jy lc ka kb kc ld ke kf kg le ki kj kk hb bi translated">S3不能将消息直接放入SQS队列，所以我们将借助Lambda函数，该函数由S3上传触发，将消息发布到SQS队列。</p><figure class="kl km kn ko fd lh er es paragraph-image"><div role="button" tabindex="0" class="li lj di lk bf ll"><div class="er es me"><img src="../Images/ef3767b1ac6468ce3ba6a6bb00a273cc.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*_caaiYNAFB4ZU0sZWnGi8A.png"/></div></div><figcaption class="lt lu et er es lv lw bd b be z dx">An S3 triggered Lambda function</figcaption></figure><figure class="kl km kn ko fd lh er es paragraph-image"><div role="button" tabindex="0" class="li lj di lk bf ll"><div class="er es mf"><img src="../Images/aaababf6aeda7c5f6b6ff461fbe4d1a2.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*wyMD4nUuUvP5xHKY9FrUdA.png"/></div></div></figure><p id="69e3" class="pw-post-body-paragraph jp jq hi jr b js la ij ju jv lb im jx jy lc ka kb kc ld ke kf kg le ki kj kk hb bi translated">该循环将持续运行，每次轮询SQS 20秒钟以获取新消息。一旦一个视频被上传，上面的Lambda函数会在队列中放置一条消息，这个脚本会看到这条消息，解析它的内容，下载并稳定视频。</p><figure class="kl km kn ko fd lh er es paragraph-image"><div role="button" tabindex="0" class="li lj di lk bf ll"><div class="er es mg"><img src="../Images/1b4cda0b2545a40f7b2e8f26371d4452.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*DznFzE5xbOSkFiMQqF79eg.png"/></div></div></figure><p id="16f2" class="pw-post-body-paragraph jp jq hi jr b js la ij ju jv lb im jx jy lc ka kb kc ld ke kf kg le ki kj kk hb bi translated">请注意从队列中删除消息的最后一个命令。当从SQS队列中读取消息时，它会暂时变得不可见，这样其他侦听器就不会拾取它。在指定的时间段后，如果消息没有被删除，视频将被重新处理，这可以通过在处理完成后删除消息来避免。</p><h1 id="a5f2" class="ix iy hi bd iz ja jb jc jd je jf jg jh io ji ip jj ir jk is jl iu jm iv jn jo bi translated">ami、启动模板和自动缩放组</h1><p id="3064" class="pw-post-body-paragraph jp jq hi jr b js jt ij ju jv jw im jx jy jz ka kb kc kd ke kf kg kh ki kj kk hb bi translated">上面的EC2实例是手工创建的。如果实例崩溃或发生更糟糕的情况，比如整个可用性区域断电，那就不太好了。再次下载ffmpeg，复制bash脚本，然后手动启动它，这将是非常乏味的。</p><p id="4f40" class="pw-post-body-paragraph jp jq hi jr b js la ij ju jv lb im jx jy lc ka kb kc ld ke kf kg le ki kj kk hb bi translated">为了避免这一切，我们可以创建一个实例的映像(AMI ),并使用该映像在以后构建新的实例。</p><figure class="kl km kn ko fd lh er es paragraph-image"><div role="button" tabindex="0" class="li lj di lk bf ll"><div class="er es mh"><img src="../Images/98b68dde358a3e91cbb4d290f16ac611.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*yco6tLGwq1J4LvQuQdFSjA.png"/></div></div></figure><p id="44f0" class="pw-post-body-paragraph jp jq hi jr b js la ij ju jv lb im jx jy lc ka kb kc ld ke kf kg le ki kj kk hb bi translated">创建好映像后，我现在可以导航到<strong class="jr mc">映像&gt;ami</strong>并手动旋转新实例。</p><p id="55a9" class="pw-post-body-paragraph jp jq hi jr b js la ij ju jv lb im jx jy lc ka kb kc ld ke kf kg le ki kj kk hb bi translated">尽管如此，我还是不想手动启动实例。这就是自动缩放和启动模板发挥作用的地方。通过<strong class="jr mc"> EC2自动缩放</strong>，我可以指定我想要运行多少个实例，以及在什么条件下添加或删除实例。例如，当SQS队列中有很多消息在等待时，我希望增加几个实例来并行处理这些消息。当队列为空时，我希望减少到只有一个实例，以<a class="ae lf" href="https://d1.awsstatic.com/whitepapers/architecture/AWS-Cost-Optimization-Pillar.pdf" rel="noopener ugc nofollow" target="_blank">节省计算时间</a>。</p><p id="0fb1" class="pw-post-body-paragraph jp jq hi jr b js la ij ju jv lb im jx jy lc ka kb kc ld ke kf kg le ki kj kk hb bi translated">为了让自动缩放创建实例，我需要指定一个<strong class="jr mc">启动模板</strong>，它本质上是对AMI和一些附加配置的引用，比如EC2角色、启动脚本和硬件。让我们首先创建一个启动模板。</p><figure class="kl km kn ko fd lh er es paragraph-image"><div role="button" tabindex="0" class="li lj di lk bf ll"><div class="er es mi"><img src="../Images/b94e39b92c58100f4fc7a54a2a140f64.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*yNTbtSbHSLczESN6SnxiCw.png"/></div></div></figure><p id="e1e2" class="pw-post-body-paragraph jp jq hi jr b js la ij ju jv lb im jx jy lc ka kb kc ld ke kf kg le ki kj kk hb bi translated">还有别忘了<strong class="jr mc">高级细节</strong>下的启动脚本。</p><figure class="kl km kn ko fd lh er es paragraph-image"><div role="button" tabindex="0" class="li lj di lk bf ll"><div class="er es mj"><img src="../Images/3cb17bf2e27e746e8410627faa7054f1.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*WQDFbCm7OvsWdbDDbQx0yw.png"/></div></div></figure><p id="77c5" class="pw-post-body-paragraph jp jq hi jr b js la ij ju jv lb im jx jy lc ka kb kc ld ke kf kg le ki kj kk hb bi translated">创建了这个启动模板后，我们现在可以创建一个自动缩放组，它将自动启动新的t2.micro实例，并预装ffmpeg和其他依赖项<em class="mk"/>，还会在启动时自动启动bash脚本。太好了。</p><figure class="kl km kn ko fd lh er es paragraph-image"><div role="button" tabindex="0" class="li lj di lk bf ll"><div class="er es ml"><img src="../Images/7d2819adcf3e509f8dce77f73745d2fb.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*6vk-bW9hf2fdc0jk8sW8MQ.png"/></div></div></figure><p id="e027" class="pw-post-body-paragraph jp jq hi jr b js la ij ju jv lb im jx jy lc ka kb kc ld ke kf kg le ki kj kk hb bi translated">让我们在这里暂停一下。上面配置的自动缩放组将使运行的EC2实例的数量保持在1到4之间。实例的数量基于一个<strong class="jr mc"> CloudWatch </strong>警报逐渐增加，该警报在指定的SQS队列上有可见消息时触发。</p><p id="1140" class="pw-post-body-paragraph jp jq hi jr b js la ij ju jv lb im jx jy lc ka kb kc ld ke kf kg le ki kj kk hb bi translated">类似地，当另一个CloudWatch警报触发时，实例会减少到单个实例，这表明CPU使用率低，因此视频稳定活动也低。<strong class="jr mc">请注意，这第二个触发器是基于CPU使用率，而不是队列消息。因为视频稳定是一个长时间运行的过程，如果队列为空，但视频仍在处理中，我不希望实例死亡。</strong></p><p id="7e61" class="pw-post-body-paragraph jp jq hi jr b js la ij ju jv lb im jx jy lc ka kb kc ld ke kf kg le ki kj kk hb bi translated">此时，实例供应是完全自动化的。如果我愿意，我可以同时上传10个视频到S3。一个Lambda函数会自动将10条消息发布到SQS队列上，这个自动伸缩组会对相应的CloudWatch警报触发做出反应，并开始创建新的实例。随着新实例的出现，消息被自动从队列中读出，视频被下载、稳定并上传回S3。最后，当事情平息下来时，自动缩放组会删除实例，直到只剩下一个。</p><h1 id="c094" class="ix iy hi bd iz ja jb jc jd je jf jg jh io ji ip jj ir jk is jl iu jm iv jn jo bi translated">从网络上传视频</h1><p id="046a" class="pw-post-body-paragraph jp jq hi jr b js jt ij ju jv jw im jx jy jz ka kb kc kd ke kf kg kh ki kj kk hb bi translated">这个足够复杂的云应用程序的最后一部分是允许匿名用户上传小视频(小于50MB)并通过网站下载稳定的结果。</p><p id="6d8d" class="pw-post-body-paragraph jp jq hi jr b js la ij ju jv lb im jx jy lc ka kb kc ld ke kf kg le ki kj kk hb bi translated">这样做实际上是一个有点棘手的任务，因为有许多安全问题(用户应该不能看到其他人的视频)以及AWS的细微差别(API网关上传限制，S3预先设计的URL)。</p><p id="80e3" class="pw-post-body-paragraph jp jq hi jr b js la ij ju jv lb im jx jy lc ka kb kc ld ke kf kg le ki kj kk hb bi translated">让我们从架构的概念开始。</p><figure class="kl km kn ko fd lh er es paragraph-image"><div class="er es mm"><img src="../Images/6ba6f33e1d5e19a1f7de077b1370b683.png" data-original-src="https://miro.medium.com/v2/resize:fit:1076/format:webp/1*_gS6b9E-7BLXvyzTWqZbPQ.png"/></div></figure><p id="2788" class="pw-post-body-paragraph jp jq hi jr b js la ij ju jv lb im jx jy lc ka kb kc ld ke kf kg le ki kj kk hb bi translated">为了保持S3存储桶的私密性，我们的想法是为用户提供一个<strong class="jr mc"> API网关</strong>端点来上传视频文件，并最终将视频放入正确的存储桶。不幸的是，API Gateway不允许上传大文件，这种方法行不通。</p><p id="6b2f" class="pw-post-body-paragraph jp jq hi jr b js la ij ju jv lb im jx jy lc ka kb kc ld ke kf kg le ki kj kk hb bi translated">经过一些研究，我了解到<a class="ae lf" href="https://docs.aws.amazon.com/AmazonS3/latest/dev/PresignedUrlUploadObject.html" rel="noopener ugc nofollow" target="_blank"> S3预先设计的URL</a>，这将允许我们获得对一个桶的临时限制访问，并直接上传文件到S3，而无需将桶公开。有了预先设计好的URL，这个架构现在看起来就像下面的视频上传图。</p><figure class="kl km kn ko fd lh er es paragraph-image"><div role="button" tabindex="0" class="li lj di lk bf ll"><div class="er es mn"><img src="../Images/e6cb3aae3971821ee77bfac69549224c.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*9bJF5LcrltgZZSZp_THG0w.png"/></div></div></figure><p id="e83c" class="pw-post-body-paragraph jp jq hi jr b js la ij ju jv lb im jx jy lc ka kb kc ld ke kf kg le ki kj kk hb bi translated">如上所述，顺序是这样的。当用户试图上传视频时，web应用程序将向API网关端点发送请求，并将相关细节传递给Lambda函数。Lambda函数要求S3提供一个预先设计好的URL，然后返回给web应用程序。然后立即发出第二个请求，将视频直接上传到S3。</p><p id="f8ed" class="pw-post-body-paragraph jp jq hi jr b js la ij ju jv lb im jx jy lc ka kb kc ld ke kf kg le ki kj kk hb bi translated">这方面的web代码相当简单，即使您不熟悉编写它的语言。</p><figure class="kl km kn ko fd lh er es paragraph-image"><div role="button" tabindex="0" class="li lj di lk bf ll"><div class="er es mo"><img src="../Images/4ee8dd15fbb7de2a2b1e523867f53128.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*DQjlrDn160UiCc8JqX1mbw.png"/></div></div><figcaption class="lt lu et er es lv lw bd b be z dx">Presigned GET and upload PUT in Elm</figcaption></figure><p id="1daa" class="pw-post-body-paragraph jp jq hi jr b js la ij ju jv lb im jx jy lc ka kb kc ld ke kf kg le ki kj kk hb bi translated">第一个函数是HTTP GET，第二个函数是HTTP PUT。首先调用<code class="du mp mq mr kq b">retrieveSignedUrl</code>,一旦获得URL，它立即被传递给<code class="du mp mq mr kq b">upload</code>的调用，视频被上传。</p><figure class="kl km kn ko fd lh er es paragraph-image"><div class="er es ls"><img src="../Images/2220849677a3fd867783bec1ed73158d.png" data-original-src="https://miro.medium.com/v2/resize:fit:1200/1*xySYxXfZBt5OLEgQcd_Xyg.gif"/></div></figure><h1 id="b2a8" class="ix iy hi bd iz ja jb jc jd je jf jg jh io ji ip jj ir jk is jl iu jm iv jn jo bi translated">下载视频</h1><p id="16fc" class="pw-post-body-paragraph jp jq hi jr b js jt ij ju jv jw im jx jy jz ka kb kc kd ke kf kg kh ki kj kk hb bi translated">一旦视频稳定完成，用户应该能够下载视频。ffmpeg需要几分钟的时间来完成它的工作，所以我们需要考虑如何告诉用户他们的视频完成了。我们可以让用户在网站打开的情况下等待，并通过web套接字或长时间轮询为用户提供下载URL。</p><p id="256c" class="pw-post-body-paragraph jp jq hi jr b js la ij ju jv lb im jx jy lc ka kb kc ld ke kf kg le ki kj kk hb bi translated">我认为更简单的解决方案是使用<strong class="jr mc"> SES </strong>。让我们在视频上传之前要求用户提供一个电子邮件地址，当EC2实例完成稳定一个视频时，它可以要求S3提供一个一小时内有效的预先设计的下载URL，并通过电子邮件将该URL发送给用户。</p><p id="73d8" class="pw-post-body-paragraph jp jq hi jr b js la ij ju jv lb im jx jy lc ka kb kc ld ke kf kg le ki kj kk hb bi translated">为了实现这一点，我们要聪明地使用标签。在请求下载URL之前，我们必须等待稳定的视频出现在S3 <em class="mk">。这意味着<strong class="jr mc">EC2实例需要按需请求预先指定的URL</strong>，这也意味着我们需要弄清楚如何在调用SES之前将用户的电子邮件地址发送到EC2实例。</em></p><p id="b704" class="pw-post-body-paragraph jp jq hi jr b js la ij ju jv lb im jx jy lc ka kb kc ld ke kf kg le ki kj kk hb bi translated">幸运的是，我们可以给S3预先设计的URL添加标签，让S3为我们自动标记这个对象。</p><figure class="kl km kn ko fd lh er es paragraph-image"><div role="button" tabindex="0" class="li lj di lk bf ll"><div class="er es ms"><img src="../Images/61868b4719eeb51b1fdfebf3bc178aec.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*GW04CLbZBZNLHd2rDAgiGA.png"/></div></div></figure><figure class="kl km kn ko fd lh er es paragraph-image"><div role="button" tabindex="0" class="li lj di lk bf ll"><div class="er es mt"><img src="../Images/09509e4439720a8a1cdbe67c8d16906e.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*OJtZQ2nt_aKHNTvVkCVwjQ.png"/></div></div></figure><p id="2a9f" class="pw-post-body-paragraph jp jq hi jr b js la ij ju jv lb im jx jy lc ka kb kc ld ke kf kg le ki kj kk hb bi translated">通过添加标签到预先设计的网址S3将自动标记上传的视频。EC2实例可以向S3索要标签，获取用户的电子邮件地址，在稳定并上传视频后，该实例将使用SES向用户发送一封带有下载链接的电子邮件。</p><p id="102d" class="pw-post-body-paragraph jp jq hi jr b js la ij ju jv lb im jx jy lc ka kb kc ld ke kf kg le ki kj kk hb bi translated">最后，这里是完成所有这些的一些支持代码。</p><figure class="kl km kn ko fd lh er es paragraph-image"><div role="button" tabindex="0" class="li lj di lk bf ll"><div class="er es mu"><img src="../Images/e9627660ec7697c1ef465ebb0ac29f94.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*vlBYq0JPQF5075J9BeMifA.png"/></div></div></figure><figure class="kl km kn ko fd lh"><div class="bz dy l di"><div class="mv mw l"/></div></figure><p id="126c" class="pw-post-body-paragraph jp jq hi jr b js la ij ju jv lb im jx jy lc ka kb kc ld ke kf kg le ki kj kk hb bi translated">就是这样！还有更多的事情要完成，但为了简洁起见，我将把事情留在这里。特别是有很多安全问题需要解决，比如限制IAM策略、添加引用源、服务器端验证和错误处理。</p><h1 id="772a" class="ix iy hi bd iz ja jb jc jd je jf jg jh io ji ip jj ir jk is jl iu jm iv jn jo bi translated">足够的复杂性</h1><p id="a705" class="pw-post-body-paragraph jp jq hi jr b js jt ij ju jv jw im jx jy jz ka kb kc kd ke kf kg kh ki kj kk hb bi translated">通过构建一个足够复杂的应用程序，我学到了很多东西，超过了我在这篇博文中所能容纳的。</p><p id="4a53" class="pw-post-body-paragraph jp jq hi jr b js la ij ju jv lb im jx jy lc ka kb kc ld ke kf kg le ki kj kk hb bi translated">需要记住的是，足够的复杂性很容易被超越。很容易有一个伟大的想法，即<em class="mk">应该</em>容易，只是看到副业项目无法在工作的第一个周末存活下来。如果你想了解更多关于云的知识，我的建议是从看起来太琐碎的事情开始，通过<a class="ae lf" href="https://aws.amazon.com/blogs/apn/the-5-pillars-of-the-aws-well-architected-framework/" rel="noopener ugc nofollow" target="_blank">五大支柱</a>开始工作。</p><ul class=""><li id="552d" class="mx my hi jr b js la jv lb jy mz kc na kg nb kk nc nd ne nf bi translated">卓越运营</li><li id="a10c" class="mx my hi jr b js ng jv nh jy ni kc nj kg nk kk nc nd ne nf bi translated">安全性</li><li id="f4b1" class="mx my hi jr b js ng jv nh jy ni kc nj kg nk kk nc nd ne nf bi translated">可靠性</li><li id="2a54" class="mx my hi jr b js ng jv nh jy ni kc nj kg nk kk nc nd ne nf bi translated">表演</li><li id="0b27" class="mx my hi jr b js ng jv nh jy ni kc nj kg nk kk nc nd ne nf bi translated">成本优化</li></ul><p id="c443" class="pw-post-body-paragraph jp jq hi jr b js la ij ju jv lb im jx jy lc ka kb kc ld ke kf kg le ki kj kk hb bi translated">在这篇文章中，我们从两个ffmpeg命令开始，并开始深入其中的至少三个支柱，在使其具有生产价值之前还有大量的工作要做。这样做让我学到了在琐碎的Hello World或过于雄心勃勃但从未完成的大想法中不会遇到的经验。</p></div></div>    
</body>
</html>