<html>
<head>
<title>OpenMP on Ubuntu</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">Ubuntu上的OpenMP</h1>
<blockquote>原文：<a href="https://medium.com/swlh/openmp-on-ubuntu-1145355eeb2?source=collection_archive---------1-----------------------#2018-10-16">https://medium.com/swlh/openmp-on-ubuntu-1145355eeb2?source=collection_archive---------1-----------------------#2018-10-16</a></blockquote><div><div class="ds gw gx gy gz ha"/><div class="hb hc hd he hf"><div class=""/><p id="409c" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">OpenMP是一个用于在多个处理器上同时执行C、C++和Fortran代码的库。如果您的代码使用了大量的循环，并且充分利用了CPU的能力，那么这将使您的代码运行得更快。如果你只是想看代码，这里的链接是<a class="ae jd" href="https://github.com/mackycheese/Ubuntu-C-CPP-Projects/tree/master/HelloOpenMP" rel="noopener ugc nofollow" target="_blank"/>。</p><h2 id="bac2" class="je jf hi bd jg jh ji jj jk jl jm jn jo iq jp jq jr iu js jt ju iy jv jw jx jy bi translated">在Ubuntu / Linux上设置OpenMP</h2><p id="eb36" class="pw-post-body-paragraph if ig hi ih b ii jz ik il im ka io ip iq kb is it iu kc iw ix iy kd ja jb jc hb bi translated">我不完全确定这在其他平台上是如何工作的。这在Mac上几乎是不可能的，在Windows上有一些奇怪的设置说明，但在Linux和Ubuntu上这真的很容易。</p><ol class=""><li id="55c1" class="ke kf hi ih b ii ij im in iq kg iu kh iy ki jc kj kk kl km bi translated">在您的终端中运行<code class="du kn ko kp kq b">sudo apt-get install libomp-dev</code>。</li><li id="49a1" class="ke kf hi ih b ii kr im ks iq kt iu ku iy kv jc kj kk kl km bi translated">创建一个<code class="du kn ko kp kq b">C++ Project</code>，并将其命名为<code class="du kn ko kp kq b">HelloOpenMP</code>。</li><li id="9c44" class="ke kf hi ih b ii kr im ks iq kt iu ku iy kv jc kj kk kl km bi translated">选择您的项目，并转到<code class="du kn ko kp kq b">Properties</code>对话框。</li><li id="65e8" class="ke kf hi ih b ii kr im ks iq kt iu ku iy kv jc kj kk kl km bi translated">去<code class="du kn ko kp kq b">C/C++ Build -&gt; Settings</code>。</li><li id="55e6" class="ke kf hi ih b ii kr im ks iq kt iu ku iy kv jc kj kk kl km bi translated">选择<code class="du kn ko kp kq b">GCC C++ Compiler / Miscellaneous</code>。</li><li id="4cb3" class="ke kf hi ih b ii kr im ks iq kt iu ku iy kv jc kj kk kl km bi translated">在<code class="du kn ko kp kq b">Other flags</code>输入中，添加<code class="du kn ko kp kq b">-fopenmp</code>。</li><li id="d13a" class="ke kf hi ih b ii kr im ks iq kt iu ku iy kv jc kj kk kl km bi translated">选择<code class="du kn ko kp kq b">GCC C++ Linker / Libraries</code>。</li><li id="8ccf" class="ke kf hi ih b ii kr im ks iq kt iu ku iy kv jc kj kk kl km bi translated">在<code class="du kn ko kp kq b">Libraries (-l)</code>字段中，点击添加按钮并输入<code class="du kn ko kp kq b">gomp</code>。</li></ol><p id="d06f" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">之后，您的属性应该看起来像这样:</p><div class="kw kx ky kz fd ab cb"><figure class="la lb lc ld le lf lg paragraph-image"><div role="button" tabindex="0" class="lh li di lj bf lk"><img src="../Images/43690f345a34de2f9ac5292699484dc5.png" data-original-src="https://miro.medium.com/v2/resize:fit:1000/format:webp/1*Ngp3r0BTHI0Bt78i1cngyg.png"/></div></figure><figure class="la lb lc ld le lf lg paragraph-image"><div role="button" tabindex="0" class="lh li di lj bf lk"><img src="../Images/77b2379e142129e469fe53f1cf8190c5.png" data-original-src="https://miro.medium.com/v2/resize:fit:1000/format:webp/1*T15JPviJF1pz8d4NyRqP3A.png"/></div><figcaption class="ln lo et er es lp lq bd b be z dx lr di ls lt">Left: compiler flags, Right: linker libraries</figcaption></figure></div><p id="1a4c" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">就是这样！</p><h2 id="3e4c" class="je jf hi bd jg jh ji jj jk jl jm jn jo iq jp jq jr iu js jt ju iy jv jw jx jy bi translated">使用OpenMP</h2><p id="d525" class="pw-post-body-paragraph if ig hi ih b ii jz ik il im ka io ip iq kb is it iu kc iw ix iy kd ja jb jc hb bi translated">假设您有一个很棒的程序，可以打印出10个数字的列表:</p><pre class="kw kx ky kz fd lu kq lv lw aw lx bi"><span id="1593" class="je jf hi kq b fi ly lz l ma mb">#include &lt;stdio.h&gt;</span><span id="0597" class="je jf hi kq b fi mc lz l ma mb">int main(){<br/>  for(int i=0;i&lt;10;i++){<br/>    printf("%i\n",i);<br/>  }<br/>  return 0;<br/>}</span></pre><p id="6022" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">这将输出如下内容:</p><pre class="kw kx ky kz fd lu kq lv lw aw lx bi"><span id="a106" class="je jf hi kq b fi ly lz l ma mb">0<br/>1<br/>2<br/>3<br/>4<br/>5<br/>6<br/>7<br/>8<br/>9</span></pre><p id="9509" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">现在，让<em class="md"> OpenMP </em>开始吧！</p><pre class="kw kx ky kz fd lu kq lv lw aw lx bi"><span id="fcff" class="je jf hi kq b fi ly lz l ma mb">#include &lt;stdio.h&gt;</span><span id="6568" class="je jf hi kq b fi mc lz l ma mb">int main(){<br/>#pragma omp parallel for<br/>  for(int i=0;i&lt;10;i++){<br/>    printf("%i\n",i);<br/>  }<br/>  return 0;<br/>}</span></pre><p id="445e" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">这将输出如下内容:</p><pre class="kw kx ky kz fd lu kq lv lw aw lx bi"><span id="7bba" class="je jf hi kq b fi ly lz l ma mb">4<br/>7<br/>6<br/>9<br/>0<br/>1<br/>8<br/>2<br/>3<br/>5</span></pre><p id="b4b5" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">这些数字是无序的，因为循环中的每次迭代都是在稍微不同的时间并行执行的。</p><p id="571f" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">等等，什么？“怎么会那么容易？”我听到你说。如果你的编译器支持OpenMP的话，实际上就是这么简单。一般来说，最新版本的GCC应该没问题。如果你的编译器不支持它，编译指令会被忽略！并且您的代码退回到单核缓慢状态。所以OpenMP完全兼容任何机器。</p><p id="92a3" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">源代码可以在<a class="ae jd" href="https://github.com/mackycheese/Ubuntu-C-CPP-Projects/tree/master/HelloOpenMP" rel="noopener ugc nofollow" target="_blank">这里</a>找到。</p><h2 id="c458" class="je jf hi bd jg jh ji jj jk jl jm jn jo iq jp jq jr iu js jt ju iy jv jw jx jy bi translated">结束了</h2><p id="0ba1" class="pw-post-body-paragraph if ig hi ih b ii jz ik il im ka io ip iq kb is it iu kc iw ix iy kd ja jb jc hb bi translated">我用我制作的自定义PPM图像库制作了一个小的mandelbrot程序:</p><pre class="kw kx ky kz fd lu kq lv lw aw lx bi"><span id="2ced" class="je jf hi kq b fi ly lz l ma mb">#include &lt;math.h&gt;<br/>#include "ppm.h"<br/>#include &lt;chrono&gt;<br/>#include "complex.h"<br/>#include "omp.h"</span><span id="ea3c" class="je jf hi kq b fi mc lz l ma mb">using namespace std::chrono;</span><span id="bfa1" class="je jf hi kq b fi mc lz l ma mb">///https://stackoverflow.com/a/19555298/9609025<br/>long curTime(){<br/>  milliseconds ms = duration_cast&lt; milliseconds &gt;(system_clock::now().time_since_epoch());<br/>  return ms.count();<br/>}</span><span id="00b6" class="je jf hi kq b fi mc lz l ma mb">int main(){<br/>  int w=1000;<br/>  int h=1000;<br/>  <br/>  ppm img;<br/>  img.setSize(w,h);<br/>  img.allocMem();</span><span id="9abb" class="je jf hi kq b fi mc lz l ma mb">  long start,end;</span><span id="db89" class="je jf hi kq b fi mc lz l ma mb">  start=curTime();<br/>#pragma omp parallel for<br/>  for(int x=0;x&lt;w;x++){<br/>#pragma omp parallel for<br/>    for(int y=0;y&lt;h;y++){<br/>//   printf("%i %i\n",x,y);<br/>      float fx=x;<br/>      float fy=y;<br/>      fx/=w;<br/>      fy/=h;<br/>      fx*=4;<br/>      fy*=4;<br/>      fx-=2;<br/>      fy-=2;</span><span id="c945" class="je jf hi kq b fi mc lz l ma mb">      complex c=fromXY(fx,fy);<br/>      complex c0=c;</span><span id="a286" class="je jf hi kq b fi mc lz l ma mb">      int max=50;<br/>      int i=0;</span><span id="c21b" class="je jf hi kq b fi mc lz l ma mb">      for(i=0;i&lt;max&amp;&amp;c.r&lt;10000;i++){<br/>       c=c^2;<br/>       c=c+c0;<br/>      }</span><span id="9661" class="je jf hi kq b fi mc lz l ma mb">      float f=((float)i)/((float)max);</span><span id="755f" class="je jf hi kq b fi mc lz l ma mb">      img.setPixel(x,y,f);<br/>    }<br/>  }</span><span id="4e0e" class="je jf hi kq b fi mc lz l ma mb">  end=curTime();</span><span id="dbf6" class="je jf hi kq b fi mc lz l ma mb">  unsigned long diff1=end-start;</span><span id="b264" class="je jf hi kq b fi mc lz l ma mb">  start=curTime();<br/>  for(int x=0;x&lt;w;x++){<br/>    for(int y=0;y&lt;h;y++){<br/>//   printf("%i %i\n",x,y);<br/>      float fx=x;<br/>      float fy=y;<br/>      fx/=w;<br/>      fy/=h;<br/>      fx*=4;<br/>      fy*=4;<br/>      fx-=2;<br/>      fy-=2;</span><span id="6a04" class="je jf hi kq b fi mc lz l ma mb">      complex c=fromXY(fx,fy);<br/>      complex c0=c;</span><span id="ccd8" class="je jf hi kq b fi mc lz l ma mb">      int max=50;<br/>      int i=0;</span><span id="e9fa" class="je jf hi kq b fi mc lz l ma mb">      for(i=0;i&lt;max&amp;&amp;c.r&lt;10000;i++){<br/>        c=c^2;<br/>        c=c+c0;<br/>      }</span><span id="bf7e" class="je jf hi kq b fi mc lz l ma mb">      float f=((float)i)/((float)max);</span><span id="dd90" class="je jf hi kq b fi mc lz l ma mb">      img.setPixel(x,y,f);<br/>    }<br/>  }<br/>  end=curTime();</span><span id="4143" class="je jf hi kq b fi mc lz l ma mb">  long diff2=end-start;</span><span id="da8f" class="je jf hi kq b fi mc lz l ma mb">  printf("With OMP    : %lums\n",diff1);<br/>  printf("Without OMP : %lums\n",diff2);<br/>  printf("Speedup     : %lums\n",diff2-diff1);</span><span id="f22c" class="je jf hi kq b fi mc lz l ma mb">  img.clamp();<br/>  img.save("mandelbrot.ppm");<br/>  img.dealloc();</span><span id="9877" class="je jf hi kq b fi mc lz l ma mb">  return 0;</span><span id="dd50" class="je jf hi kq b fi mc lz l ma mb">}</span></pre><p id="6140" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">在我的电脑上，它会显示以下内容:</p><pre class="kw kx ky kz fd lu kq lv lw aw lx bi"><span id="5ee8" class="je jf hi kq b fi ly lz l ma mb">With OMP    : 451ms<br/>Without OMP : 1475ms<br/>Speedup     : 1024ms</span></pre><p id="71ee" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">相当牛逼！</p><p id="8af5" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">这可以应用于C++中任何可以独立于其他迭代执行的循环，具有巨大的加速。当OpenMP和我的一些路径跟踪算法一起使用时，我获得了更大的加速。</p><p id="3e03" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">这个新的库使得在CPU上同时运行多个东西变得更加容易，并且与OpenCL相比，更易于使用。</p><figure class="kw kx ky kz fd lb er es paragraph-image"><a href="https://medium.com/swlh"><div class="er es me"><img src="../Images/308a8d84fb9b2fab43d66c117fcc4bb4.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*YqDjlKFwScoQYQ62DWEdig.png"/></div></a></figure><h2 id="c148" class="je jf hi bd jg jh ji jj jk jl jm jn jo iq jp jq jr iu js jt ju iy jv jw jx jy bi translated">这篇文章发表在<a class="ae jd" href="https://medium.com/swlh" rel="noopener"> The Startup </a>上，这是Medium最大的创业刊物，拥有+ 379，528名读者。</h2><h2 id="869c" class="je jf hi bd jg jh ji jj jk jl jm jn jo iq jp jq jr iu js jt ju iy jv jw jx jy bi translated">在这里订阅接收<a class="ae jd" href="http://growthsupply.com/the-startup-newsletter/" rel="noopener ugc nofollow" target="_blank">我们的头条新闻</a>。</h2><figure class="kw kx ky kz fd lb er es paragraph-image"><a href="https://medium.com/swlh"><div class="er es me"><img src="../Images/b0164736ea17a63403e660de5dedf91a.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*ouK9XR4xuNWtCes-TIUNAw.png"/></div></a></figure></div></div>    
</body>
</html>