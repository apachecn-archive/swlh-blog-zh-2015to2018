# 以低廉的价格扩展

> 原文：<https://medium.com/swlh/scaling-on-the-cheap-933e46944886>

![](img/9aa86fc096e50b405af8381efc3d3ad0.png)

> “规划就是把未来带入现在，这样你现在就可以做些什么了”——艾伦·莱克因

我将从我的技术招聘和团队建设系列中休息一下，写一篇更具技术性的文章。

我联合创办了一家公司。我们没有投资者。我们不是在寻找投资者。创意很便宜，对创意的估值更便宜。我们有一个想法，需要在预算有限的情况下维持我们的服务器。本文是我们如何做到这一点以及您如何也能做到这一点的系列文章中的第一篇。

## 开始步入正轨

> “做事情并不需要很大的力量，但决定做什么却需要很大的力量。”——阿尔伯特·哈伯德

当你开始一件新的事情时，没有什么不好的，没有什么不好的，没有什么你需要解释或感到尴尬的。另一方面，有这么多的可能性，它可以压倒一切。这是你做出决定的时候，这些决定要么会带来巨大的回报，要么会导致系统性的失败，如果不重做一切，这种失败基本上是不可恢复的。**这个**是你需要开始考虑规模的地方。这并不意味着过早地优化登录流程，或者购买庞大的服务器。这意味着以一种能让你以很少的前期成本避免未来痛苦的方式来思考架构。也就是说，你**可以**随时听从这个建议。也许它能有所帮助，也许你在另一条道路上走得太远，这取决于你自己。

## 第一条戒律

**永远不要在单独请求的基础上在服务器上呈现 HTML 以传送到网络浏览器**。永远不会。正如我将要解释的，这条规则将会给你巨大的回报。不仅仅是在伸缩性方面，在代码重用、未来扩展等方面也是如此。

我们的服务器有两个部分:静态端和 API 端。值得考虑将这些放在两个独立的回购中(这样它们就不会混在一起)。

值得注意的是，“基于个人请求”确实给了你一点灵活性。在构建时从模板**中呈现静态 html 完全没问题，而且通常更好。这可以让你避免重复常见的片段，如页眉和页脚，分析代码等。**

## 静态站点

我们的静态站点是纯粹的、普通的 HTML/CSS(带有一些嵌入的脚本标签，等等，我在这里就不赘述了)。这由我们的 web 服务器提供服务，并由我们的 CDN(在我们的例子中是 Cloudflare)进行扩展。正因为如此，我们可以以与 Techcrunch、Gizmodo、Engadget 或任何其他你想在网络上提到的大玩家相同的速度提供静态页面。这种方法的美妙之处在于它几乎不花我们什么钱，只需要一点点时间来提前计划。

## API 服务器

显然，如果我们只有一个静态的网站，它会很无聊。我们的数据来自我们的 API 服务器。API 服务器负责所有关于用户的唯一数据，响应他们的更新，等等。所有你通常会联想到的动态活动。每个请求都会产生一些 JSON。重要的是，不要从这里开始，也不要把东西扔进桶里，称之为 API。为了理解什么和如何需要数据，你需要首先设计你的网站的布局和流程。一旦有了这些，将这些需求组织成逻辑组就很重要了(/api/user/、/api/album/，等等)。关于 API 设计的建议超出了这篇文章的范围，但是我会在后面写。

## 走出黑暗时代

不太久以前，Javascript 版本没有得到足够的跨浏览器的一致支持，以至于我们甚至梦想用它来主要显示我们的内容。IE 6 在网上漫游，可以吃掉你想吃的一半而不受惩罚。那些日子(谢天谢地)已经过去了。现在所有现代浏览器都可以至少渲染 ES5，通过[巴别塔](https://babeljs.io/)、 [Modernizr](https://modernizr.com/) 和类似工具的帮助，我们甚至可以使用许多 ES2015(或 ES6)功能。除此之外，JS 引擎已经变得更快了(尤其是在移动设备上)，一般来说，计算机(一如既往)也变得更快了。这些因素结合在一起，为我们分配扩展需求创造了一个完美的环境。

## 一百万个渲染引擎

那么我们应该在哪里生成我们的动态页面呢？当然是客户。不是 1 台(或 10 或 20 台)服务器做一百万次渲染并提供一个页面，而是一百万台客户机各做一次渲染。为此，我们使用[电抗器](https://facebook.github.io/react/)。有几个其他选项，但我们选择 React，因为它非常适合我们喜欢的功能反应式风格( [Aurelia](http://aurelia.io/) 是另一个很好的框架)。我个人不喜欢 AngularJS 目前的样子，但这是另一篇博文的主题。

一旦 JSON 负载从我们的服务器返回，我们就在客户机上缓存并呈现它。这里需要注意的是，我们的应用是单页应用(SPA)。虽然您不必使用 SPA 来使用这种技术，但是如果您需要访问相同数据的多个页面(或者您需要在不滥用服务器的情况下支持快速后退和前进按钮导航)，您可以在 [localstorage](http://www.html5rocks.com/en/features/storage) 中缓存您的 JSON 响应(除非您需要支持 IE 6 或其他什么，在这种情况下，您需要寻找另一份不阅读这篇博客文章的工作)。

## 收取股息

既然我们已经在提供数据的 API 和消费数据的 HTML/JS 之间建立了一条硬线，让我们看看我们得到了什么(同样，几乎免费):

代码的重复显著减少。

> 做错事越痛苦，我们就越有可能做正确的事

当我们编写在服务器上生成的页面时，你可能会发现一些基本上做同样事情的代码到处都是。这并不是因为任何编码上的不当行为，这只是因为人们太匆忙了，以为其他地方还没有完成。API 层减少了这种情况，因为创建一个 API 有更高的“激活能量”(开始做某事所需要的能量)。在我们添加一个新的 API 之前(必须想出一个名字，添加样板文件，对它进行适当的分类，等等),我们很可能要看看一个现有的 API 是否适合我们。

**一切都是一等公民**

> 先手机 app？Web 优先？都不是。万事第一。

因为在渲染我们的网站时，我们不直接访问我们的后端，我们的 web 客户端可以做的任何事情，我们的移动客户端现在也可以访问！此外，如果我们精心设计了我们的 API(遗憾的是，这个话题超出了本文的范围)，我们甚至可以轻松地引入第三方合作伙伴，与他们共享数据。

**缩小攻击面**

因为我们在后端消除了相当大的一部分代码(模板、嵌入式 HTML、HTML 生成引擎等等)，我们减少了它被攻击的方式。很容易确保每个新的 API 都验证其输入，因为这些输入并不经常添加，而且相对于嵌入了大量 HTML 的整个页面来说，它们往往非常小。此外，如果一些奇怪的数据导致渲染崩溃，这只会发生在一个浏览器中，而不会影响许多其他未受影响的客户端。

**你的 CDN 可以做自己的事**

![](img/149e36ef1b5718fdcfe015e8c95f080b.png)

这是我们实际的交通高峰之一。橙色是我们的 CDN 从缓存提供的流量，蓝色是我们从 web 服务器提供的流量。这一差异大约是 10 万个请求。这是 10 万个不需要我们提供服务器资源的请求。

你可能永远也不会比你的 CDN 更擅长提供网页服务。如果是的话，你要么是一个数十亿美元的公司，要么你需要一个新的 CDN。因为你所有的页面现在都是静态的，你的 CDN 可以提供 DDoS 保护，并在你受到打击时吸收负载。这也意味着你可以省钱，因为你需要一个不那么结实的盒子。如果你注意到你的 API 服务器被滥用，你有更多的选择。仅举一个例子，您可以暂时稍微延迟响应。用户不会注意到什么(可能 50-100 毫秒)，但会显著减慢攻击者的速度，同时几乎不花费任何成本(假设您以非阻塞方式处理您的请求)。这是可能的，因为合法用户在您处理恶意行为者时不会看到空白页面。他们看到的是部分页面，至少让他们知道你正在加载他们的请求。你的 CDN 甚至可以在短期内缓存一些 API 响应。

## 那么下一步是什么？

在接下来的几周里，我将谈论构建优秀 API 的规则，一些关于如何构建前端应用程序的建议以及其他相关主题。敬请期待！

## 关于我

我是 Amir Yasin，是一名通晓多种语言的开发人员，对高性能、可伸缩性、软件架构和解决难题非常感兴趣。你可以[在 Medium](/@ayasin) 上关注我关于软件工程的博客，[在 Twitter](https://twitter.com/ayasin) 上关注我偶尔说的有趣的事情，或者在 GitHub 上查看[我对自由/开源软件社区的贡献。](https://github.com/ayasin)

**如果你喜欢这篇文章，我会非常感谢你的推荐(点击下面的心脏)**。

![](img/c1192ebad88d6b1fc6ae1d6a2bc61154.png)

发表于*[**【SWLH】**](https://medium.com/swlh)**(***创业、流浪、生活黑客)**

*[![](img/de26c089e79a3a2a25d2b750ff6db50f.png)](http://supply.us9.list-manage.com/subscribe?u=310af6eb2240d299c7032ef6c&id=d28d8861ad)**[![](img/f47a578114e0a96bdfabc3a5400688d5.png)](https://medium.com/swlh)**[![](img/c1351daa9c4f0c8ac516addb60c82f6b.png)](https://twitter.com/swlh_)*