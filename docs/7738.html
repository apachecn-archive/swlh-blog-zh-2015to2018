<html>
<head>
<title>Dynamic AppEngine Configurations using Gradle Part 2</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">使用Gradle的动态AppEngine配置第2部分</h1>
<blockquote>原文：<a href="https://medium.com/swlh/dynamic-appengine-configurations-using-gradle-part-2-49a30eb87672?source=collection_archive---------8-----------------------#2018-11-29">https://medium.com/swlh/dynamic-appengine-configurations-using-gradle-part-2-49a30eb87672?source=collection_archive---------8-----------------------#2018-11-29</a></blockquote><div><div class="ds gw gx gy gz ha"/><div class="hb hc hd he hf"><figure class="hh hi ez fb hj hk er es paragraph-image"><div role="button" tabindex="0" class="hl hm di hn bf ho"><div class="er es hg"><img src="../Images/833e15631d18caf8fb56059b9ddadbc9.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*gy6JvSGebDZtqPjss4Hi1g.jpeg"/></div></div><figcaption class="hr hs et er es ht hu bd b be z dx">Appengine + Gradle Power</figcaption></figure><div class=""/><p id="1ff7" class="pw-post-body-paragraph iu iv hx iw b ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr hb bi translated">在之前的故事<a class="ae js" rel="noopener" href="/swlh/dynamic-appengine-configurations-using-gradle-part-1-e3959a39f31b">使用gradle的动态AppEngine配置第1部分</a>中，我们讨论了如何使用简单的Gradle参数轻松部署到各种环境，如(生产、测试、测试)。如果您之前没有阅读过，建议您在继续之前阅读。</p><p id="9012" class="pw-post-body-paragraph iu iv hx iw b ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr hb bi translated">现在让我们来看看如何为每种环境创建多个<a class="ae js" href="https://cloud.google.com/appengine/docs/standard/java/configuration-files" rel="noopener ugc nofollow" target="_blank">配置文件</a> ( <a class="ae js" href="https://cloud.google.com/appengine/docs/standard/java/config/cronref" rel="noopener ugc nofollow" target="_blank"> cron.xml </a>，<a class="ae js" href="https://cloud.google.com/appengine/docs/standard/java/config/appref" rel="noopener ugc nofollow" target="_blank"> appengine-web.xml </a>，queue.xml)</p></div><div class="ab cl jt ju gp jv" role="separator"><span class="jw bw bk jx jy jz"/><span class="jw bw bk jx jy jz"/><span class="jw bw bk jx jy"/></div><div class="hb hc hd he hf"><h1 id="55d7" class="ka kb hx bd kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx bi translated">可选配置文件</h1><blockquote class="ky kz la"><p id="4248" class="iu iv lb iw b ix iy iz ja jb jc jd je lc jg jh ji ld jk jl jm le jo jp jq jr hb bi translated">这些配置文件控制应用于应用程序中所有服务的可选功能:</p></blockquote><ul class=""><li id="0b28" class="lf lg hx iw b ix iy jb jc jf lh jj li jn lj jr lk ll lm ln bi translated"><code class="du lo lp lq lr b"><a class="ae js" href="https://cloud.google.com/appengine/docs/standard/java/reference/dispatch-yaml" rel="noopener ugc nofollow" target="_blank">dispatch.xml</a> (routing)</code></li><li id="d3e4" class="lf lg hx iw b ix ls jb lt jf lu jj lv jn lw jr lk ll lm ln bi translated"><code class="du lo lp lq lr b"><a class="ae js" href="https://cloud.google.com/appengine/docs/standard/java/config/queueref" rel="noopener ugc nofollow" target="_blank">queue.xml</a> (task processing)</code></li><li id="6617" class="lf lg hx iw b ix ls jb lt jf lu jj lv jn lw jr lk ll lm ln bi translated"><code class="du lo lp lq lr b"><a class="ae js" href="https://cloud.google.com/appengine/docs/standard/java/config/indexref" rel="noopener ugc nofollow" target="_blank">datastore-indexes.xml</a> (querying)</code></li><li id="efbd" class="lf lg hx iw b ix ls jb lt jf lu jj lv jn lw jr lk ll lm ln bi translated"><code class="du lo lp lq lr b"><a class="ae js" href="https://cloud.google.com/appengine/docs/standard/java/config/cronref" rel="noopener ugc nofollow" target="_blank">cron.xml</a> (scheduling)</code></li></ul><p id="cce0" class="pw-post-body-paragraph iu iv hx iw b ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr hb bi translated">为了让每个环境有不同的配置，我们将在根文件夹中创建一个名为<strong class="iw lx"> gaeconfigs </strong>的文件夹，并在该文件夹下为每个环境创建一个<strong class="iw lx">文件夹，如下所示:</strong></p><figure class="lz ma mb mc fd hk er es paragraph-image"><div class="er es ly"><img src="../Images/70887dc905bb69084f44d38fee225281.png" data-original-src="https://miro.medium.com/v2/resize:fit:648/format:webp/1*qiGoPi_WirSFIeGjDorMmw.png"/></div><figcaption class="hr hs et er es ht hu bd b be z dx">Folder structure for each environment</figcaption></figure><p id="8c98" class="pw-post-body-paragraph iu iv hx iw b ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr hb bi translated">现在继续为每个环境添加这些配置文件，它看起来像这样，</p><figure class="lz ma mb mc fd hk er es paragraph-image"><div class="er es md"><img src="../Images/c87ad6d67ababa555dd64a48c45e41b0.png" data-original-src="https://miro.medium.com/v2/resize:fit:644/format:webp/1*nRteKPz25GhT4notVZIdGQ.png"/></div><figcaption class="hr hs et er es ht hu bd b be z dx">Environment specific configuration files</figcaption></figure><p id="049e" class="pw-post-body-paragraph iu iv hx iw b ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr hb bi translated">例如，您现在可以根据环境编辑或优化配置</p><ul class=""><li id="e937" class="lf lg hx iw b ix iy jb jc jf lh jj li jn lj jr lk ll lm ln bi translated">对于队列，<strong class="iw lx">分段</strong>的加工速率为10/秒，对于生产，加工速率可以为100/秒</li><li id="ac75" class="lf lg hx iw b ix ls jb lt jf lu jj lv jn lw jr lk ll lm ln bi translated">在生产中，数据处理Cron应该每5分钟运行一次，但对于转移，它可以每小时运行一次</li></ul><p id="bea5" class="pw-post-body-paragraph iu iv hx iw b ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr hb bi translated"><strong class="iw lx">适用于所有环境的通用配置如何？</strong></p><p id="1847" class="pw-post-body-paragraph iu iv hx iw b ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr hb bi translated">有时，某些配置不会因每个环境而改变，如<a class="ae js" href="https://cloud.google.com/appengine/docs/standard/java/config/indexref" rel="noopener ugc nofollow" target="_blank"> datastore-indexes.xml </a>，或者您对所有环境都有相同的设置，在这种情况下，请将这些配置直接放在<strong class="iw lx"> gaeconfigs </strong>文件夹下，我们也会处理它们。比如，</p><figure class="lz ma mb mc fd hk er es paragraph-image"><div class="er es me"><img src="../Images/0430a067ee52bbe971e34d65bf67914c.png" data-original-src="https://miro.medium.com/v2/resize:fit:650/format:webp/1*QGR4OFO2LlbxM5KGGhUUQQ.png"/></div><figcaption class="hr hs et er es ht hu bd b be z dx">Common configurations</figcaption></figure><p id="b718" class="pw-post-body-paragraph iu iv hx iw b ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr hb bi translated">一切就绪，现在我们需要在部署期间使用这些配置。我们将使用一个梯度任务来完成这个任务，</p><figure class="lz ma mb mc fd hk"><div class="bz dy l di"><div class="mf mg l"/></div><figcaption class="hr hs et er es ht hu bd b be z dx">gradle copy configuration task</figcaption></figure><p id="0e04" class="pw-post-body-paragraph iu iv hx iw b ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr hb bi translated">让我们来理解发生了什么，首先，我们声明必要的目录路径:</p><pre class="lz ma mb mc fd mh lr mi mj aw mk bi"><span id="0598" class="ml kb hx lr b fi mm mn l mo mp">def configDir = "${project.projectDir}/gaeconfigs"</span><span id="6bee" class="ml kb hx lr b fi mq mn l mo mp">def targetDir = "${buildDir}/exploded-" + project.name + "/WEB-INF"</span><span id="36b6" class="ml kb hx lr b fi mq mn l mo mp">def envName = getDeployConfig().mode //live or stag etc</span></pre><p id="3540" class="pw-post-body-paragraph iu iv hx iw b ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr hb bi translated"><strong class="iw lx"> <em class="lb"> configDir </em> </strong>:指向<strong class="iw lx"> gaeconfigs </strong>文件夹<br/> <strong class="iw lx"> <em class="lb"> envName </em> </strong>:环境值如<strong class="iw lx"> live </strong>或<strong class="iw lx"> stag </strong>或<strong class="iw lx">alpha</strong><br/><strong class="iw lx"><em class="lb">targetDir</em></strong>:指向appengine explodedWar的WEB-INF目录，其格式为</p><p id="edb4" class="pw-post-body-paragraph iu iv hx iw b ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr hb bi translated">然后，我们将<strong class="iw lx"> gaeconfigs </strong>文件夹下的常见配置，如(datastore-indexes.xml，dos.xml)复制到<em class="lb"> WEB-INF </em>目录，这忽略了环境文件夹，代码如下:</p><pre class="lz ma mb mc fd mh lr mi mj aw mk bi"><span id="434d" class="ml kb hx lr b fi mm mn l mo mp">from configDir<br/>include '*.xml'<br/>into targetDir</span></pre><p id="7ee9" class="pw-post-body-paragraph iu iv hx iw b ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr hb bi translated">然后根据任务执行期间传递的<strong class="iw lx">模式</strong>标志，我们将配置从模式特定的环境目录复制到<strong class="iw lx"> <em class="lb"> WEB-INF </em> </strong>目录，</p><pre class="lz ma mb mc fd mh lr mi mj aw mk bi"><span id="0688" class="ml kb hx lr b fi mm mn l mo mp">// copying env based configs<br/>from fileTree(configDir + "/" + envName)<br/>include '*.xml'<br/>into targetDir</span></pre><p id="93b6" class="pw-post-body-paragraph iu iv hx iw b ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr hb bi translated">例如，当模式为<code class="du lo lp lq lr b">-Pmode=live</code>时，从<code class="du lo lp lq lr b">gaeconfigs/live</code>复制文件。最后，我们将这个任务绑定到<strong class="iw lx">explode war</strong>任务，这个任务将在本地运行或部署期间被调用</p><pre class="lz ma mb mc fd mh lr mi mj aw mk bi"><span id="c1d3" class="ml kb hx lr b fi mm mn l mo mp">explodeWar.finalizedBy copyGaeConfig</span></pre><p id="f99b" class="pw-post-body-paragraph iu iv hx iw b ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr hb bi translated">就是这样。简单对吗？现在，对于部署，只需运行以下命令，它会自动复制必要的配置</p><pre class="lz ma mb mc fd mh lr mi mj aw mk bi"><span id="8f83" class="ml kb hx lr b fi mm mn l mo mp">gradle appengineDeploy -Pmode=live</span></pre><p id="3081" class="pw-post-body-paragraph iu iv hx iw b ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr hb bi translated">让我们看看另一个我们还没有涉及的重要配置文件。</p></div><div class="ab cl jt ju gp jv" role="separator"><span class="jw bw bk jx jy jz"/><span class="jw bw bk jx jy jz"/><span class="jw bw bk jx jy"/></div><div class="hb hc hd he hf"><h1 id="ffd0" class="ka kb hx bd kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx bi translated"><a class="ae js" href="https://cloud.google.com/appengine/docs/standard/java/config/appref" rel="noopener ugc nofollow" target="_blank"> appengine-web.xml </a></h1><blockquote class="ky kz la"><p id="b129" class="iu iv lb iw b ix iy iz ja jb jc jd je lc jg jh ji ld jk jl jm le jo jp jq jr hb bi translated">这是一个主要文件，用于指定有关您的应用程序的信息，并确定应用程序的WAR中哪些文件是静态文件(如图像)，哪些是应用程序使用的资源文件。</p></blockquote><p id="b03f" class="pw-post-body-paragraph iu iv hx iw b ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr hb bi translated">与其他配置不同，该文件特定于单个模块(服务)。我们来看一个样本<strong class="iw lx"><em class="lb">app engine-web . XML</em></strong>文件，</p><figure class="lz ma mb mc fd hk"><div class="bz dy l di"><div class="mf mg l"/></div><figcaption class="hr hs et er es ht hu bd b be z dx">appengine-web.xml file</figcaption></figure><p id="1bda" class="pw-post-body-paragraph iu iv hx iw b ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr hb bi translated">在这里，我们已经定义了服务、静态文件和扩展配置。问题是，如果我们需要根据我们所处的环境来更改扩展配置，该怎么办呢？</p><p id="e681" class="pw-post-body-paragraph iu iv hx iw b ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr hb bi translated">首先，我们将更改<strong class="iw lx"><em class="lb">app engine-web . XML</em></strong>文件，如下所示:</p><figure class="lz ma mb mc fd hk"><div class="bz dy l di"><div class="mf mg l"/></div><figcaption class="hr hs et er es ht hu bd b be z dx">appengine-web.xml with placeholder properties</figcaption></figure><p id="06b3" class="pw-post-body-paragraph iu iv hx iw b ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr hb bi translated">注意到什么了吗？检查这个，</p><pre class="lz ma mb mc fd mh lr mi mj aw mk bi"><span id="6c0b" class="ml kb hx lr b fi mm mn l mo mp">&lt;instance-class&gt;@INSTANCE_CLASS@&lt;/instance-class&gt;<br/>@SCALING_CONFIG@</span></pre><p id="6fc2" class="pw-post-body-paragraph iu iv hx iw b ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr hb bi translated">我们只是用<strong class="iw lx">占位符</strong>名称<strong class="iw lx"> <em class="lb"> @INSTANCE_CLASS@ </em> </strong>和<strong class="iw lx"><em class="lb">@ SCALING _ CONFIG @</em></strong>替换了静态值，它们将在部署期间借助以下任务进行替换。</p><figure class="lz ma mb mc fd hk"><div class="bz dy l di"><div class="mf mg l"/></div></figure><p id="d1f2" class="pw-post-body-paragraph iu iv hx iw b ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr hb bi translated">因此，在<code class="du lo lp lq lr b"><strong class="iw lx">getGaeWebXmlConfig()</strong></code>函数中，基于<strong class="iw lx">模式</strong>标志，我们正在为<strong class="iw lx"> <em class="lb">实例_类</em> </strong> &amp; <strong class="iw lx"> <em class="lb">缩放_配置</em> </strong>设置值，注意，对于缩放，我们只为活动&amp; alpha添加了一整套设置，但对于暂存，则使用默认值(这也有助于保持暂存成本较低)。</p><p id="b202" class="pw-post-body-paragraph iu iv hx iw b ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr hb bi translated">在<strong class="iw lx"> explodeWar </strong>任务中，我们正在读取<code class="du lo lp lq lr b">appengine-web.xml</code>文件并用生成的文件替换占位符属性，最后，它被写入构建目录。</p><blockquote class="ky kz la"><p id="ac3a" class="iu iv lb iw b ix iy iz ja jb jc jd je lc jg jh ji ld jk jl jm le jo jp jq jr hb bi translated"><strong class="iw lx">注意:</strong> <em class="hx">原来的</em> <code class="du lo lp lq lr b"><em class="hx">appengine-web.xml</em></code> <em class="hx">文件将原封不动</em></p></blockquote><p id="1bad" class="pw-post-body-paragraph iu iv hx iw b ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr hb bi translated">仅此而已。现在，每次运行以下命令时</p><pre class="lz ma mb mc fd mh lr mi mj aw mk bi"><span id="2136" class="ml kb hx lr b fi mm mn l mo mp">gradle appengineDeploy -Pmode=live</span></pre><p id="367b" class="pw-post-body-paragraph iu iv hx iw b ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr hb bi translated">所有基于环境的配置都被自动配置并复制到构建目录中。<strong class="iw lx"> <em class="lb">更多查看GitHub中的演示应用，</em> </strong></p><div class="hh hi ez fb hj mr"><a href="https://github.com/ramesh-dev/gae-dynamic-config-demo" rel="noopener  ugc nofollow" target="_blank"><div class="ms ab dw"><div class="mt ab mu cl cj mv"><h2 class="hy b fi z dy mw ea eb mx ed ef hw bi translated">Ramesh-dev/gae-动态-配置-演示</h2><div class="my l"><h3 class="bd b fi z dy mw ea eb mx ed ef dx translated">AppEngine动态配置演示。为Ramesh-dev/gae-dynamic-config-demo开发做出贡献，创建一个…</h3></div><div class="mz l"><p class="bd b fp z dy mw ea eb mx ed ef dx translated">github.com</p></div></div><div class="na l"><div class="nb l nc nd ne na nf hp mr"/></div></div></a></div><h1 id="02b3" class="ka kb hx bd kc kd ng kf kg kh nh kj kk kl ni kn ko kp nj kr ks kt nk kv kw kx bi translated">结论</h1><p id="c9ad" class="pw-post-body-paragraph iu iv hx iw b ix nl iz ja jb nm jd je jf nn jh ji jj no jl jm jn np jp jq jr hb bi translated">这就是这个故事的全部技巧。使用这些技术，您还可以进行其他种类的配置和供应，如复制应用程序设置、标志、凭证等。如果你看一下，我们只是使部署变得更加容易。</p><p id="6e66" class="pw-post-body-paragraph iu iv hx iw b ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr hb bi translated">感谢阅读！<strong class="iw lx">部署愉快… </strong></p><p id="2c9c" class="pw-post-body-paragraph iu iv hx iw b ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr hb bi translated">这里是另一个有用参考，</p><ul class=""><li id="2252" class="lf lg hx iw b ix iy jb jc jf lh jj li jn lj jr lk ll lm ln bi translated"><a class="ae js" rel="noopener" href="/swlh/dynamic-appengine-configurations-using-gradle-part-1-e3959a39f31b">使用Gradle第1部分的动态AppEngine配置</a></li><li id="19c2" class="lf lg hx iw b ix ls jb lt jf lu jj lv jn lw jr lk ll lm ln bi translated"><a class="ae js" rel="noopener" href="/@rameshlingappa/auto-detect-app-mode-in-google-appengine-fd7749b100c3">Google app engine中的自动检测环境</a></li><li id="6bfc" class="lf lg hx iw b ix ls jb lt jf lu jj lv jn lw jr lk ll lm ln bi translated"><a class="ae js" rel="noopener" href="/@rameshlingappa/multi-module-projects-with-google-appengine-and-intellij-b3b2bc271bb1">Google app engine和IntelliJ的多模块项目</a></li></ul><figure class="lz ma mb mc fd hk er es paragraph-image"><a href="https://medium.com/swlh"><div class="er es nq"><img src="../Images/308a8d84fb9b2fab43d66c117fcc4bb4.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*YqDjlKFwScoQYQ62DWEdig.png"/></div></a></figure><h2 id="c148" class="ml kb hx bd kc nr ns nt kg nu nv nw kk jf nx ny ko jj nz oa ks jn ob oc kw od bi translated">这篇文章发表在<a class="ae js" href="https://medium.com/swlh" rel="noopener"> The Startup </a>上，这是Medium最大的创业刊物，拥有+393，714名读者。</h2><h2 id="869c" class="ml kb hx bd kc nr ns nt kg nu nv nw kk jf nx ny ko jj nz oa ks jn ob oc kw od bi translated">在这里订阅接收<a class="ae js" href="http://growthsupply.com/the-startup-newsletter/" rel="noopener ugc nofollow" target="_blank">我们的头条新闻</a>。</h2><figure class="lz ma mb mc fd hk er es paragraph-image"><a href="https://medium.com/swlh"><div class="er es nq"><img src="../Images/b0164736ea17a63403e660de5dedf91a.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*ouK9XR4xuNWtCes-TIUNAw.png"/></div></a></figure></div></div>    
</body>
</html>